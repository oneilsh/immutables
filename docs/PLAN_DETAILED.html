<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Refactor Plan (Detailed) • immutables</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Refactor Plan (Detailed)"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">immutables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/flexseq.html">Getting Started with flexseq</a></li>
    <li><a class="dropdown-item" href="articles/priority-queues.html">Priority Queues</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/oneilsh/immutables/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Refactor Plan (Detailed)</h1>
      <small class="dont-index">Source: <a href="https://github.com/oneilsh/immutables/blob/HEAD/PLAN_DETAILED.md"><code>PLAN_DETAILED.md</code></a></small>
    </div>

<div id="refactor-plan-detailed" class="section level1">

<p>This plan operationalizes <code>PLAN_HIGH_LEVEL.md</code> for a naive implementation agent.</p>
<p>Primary objective: - Reorganize code around: 1. reference finger-tree implementation in R (lambda.r style), and 2. optional C++ acceleration path for speed-critical operations.</p>
<p>Reference basis: - Hinze, R. and Paterson, R. (2006), <em>Finger trees: a simple general-purpose data structure</em>. <a href="https://www.cs.ox.ac.uk/ralf.hinze/publications/FingerTrees.pdf" class="external-link uri">https://www.cs.ox.ac.uk/ralf.hinze/publications/FingerTrees.pdf</a></p>
<p>Non-objectives for this plan: - No intentional behavior changes. - No broad API redesign. - No new data structures.</p>
<div class="section level2">
<h2 id="hard-constraints">Hard Constraints<a class="anchor" aria-label="anchor" href="#hard-constraints"></a></h2>
<ol style="list-style-type: decimal"><li>Preserve exported API semantics unless explicitly approved by user.</li>
<li>Keep C++/R backend parity contract intact (<code>tests/testthat/test-cpp-parity.R</code>).</li>
<li>Keep reference semantics in R as source of truth.</li>
<li>Keep CRAN cleanliness (<code>R CMD check</code>) and docs integrity (<code>roxygen2</code>, pkgdown).</li>
<li>Do not commit build artifacts (<code>immutables.Rcheck</code>, tarballs).</li>
</ol></div>
<div class="section level2">
<h2 id="preflight-checklist-must-pass-before-refactor">Preflight Checklist (must pass before refactor)<a class="anchor" aria-label="anchor" href="#preflight-checklist-must-pass-before-refactor"></a></h2>
<ol style="list-style-type: decimal"><li>Confirm current status and collect baseline:</li>
</ol><ul><li><code>git status --short</code></li>
<li><code>R -q -e "testthat::test_local()"</code></li>
<li><code>R -q -e "roxygen2::roxygenise()"</code></li>
<li><code>R CMD build .</code></li>
<li><code>R CMD check --no-manual immutables_*.tar.gz</code></li>
</ul><ol start="2" style="list-style-type: decimal"><li>Record baseline outcomes in a short note in commit message or PR body.</li>
<li>If unrelated dirty changes exist, do not revert them; isolate your edits.</li>
</ol></div>
<div class="section level2">
<h2 id="current-source-inventory-as-of-this-plan">Current Source Inventory (as of this plan)<a class="anchor" aria-label="anchor" href="#current-source-inventory-as-of-this-plan"></a></h2>
<p>Core/internal mixed today: - <code>R/00-helpers.R</code> - <code>R/constructors.R</code> - <code>R/measured.R</code> - <code>R/monoid_resolution.R</code> - <code>R/view.R</code> - <code>R/split_digit.R</code> - <code>R/split_tree_impl.R</code> - <code>R/locate_impl.R</code> - <code>R/add_left.R</code> - <code>R/add_right.R</code> - <code>R/concat.R</code> - <code>R/cpp_backend.R</code> - <code>R/utils.R</code></p>
<p>User-facing/API-adjacent today: - <code>R/flexseq.R</code>, <code>R/append.R</code>, <code>R/prepend.R</code> - <code>R/fold_left.R</code>, <code>R/fold_right.R</code> - <code>R/split.R</code>, <code>R/split_tree.R</code>, <code>R/locate.R</code> - <code>R/indexing.R</code>, <code>R/dollar.R</code> - <code>R/add_monoids.R</code>, <code>R/validate.R</code> - <code>R/MeasureMonoid.R</code>, <code>R/Predicate.R</code> - <code>R/concat_trees.R</code>, <code>R/tree_from.R</code>, <code>R/empty_tree.R</code> - <code>R/print.FingerTree.R</code>, <code>R/print.priority_queue.R</code> - <code>R/priority_queue.R</code>, <code>R/pq_monoids.R</code></p>
</div>
<div class="section level2">
<h2 id="target-file-layout">Target File Layout<a class="anchor" aria-label="anchor" href="#target-file-layout"></a></h2>
<p>Create/rename to these families:</p>
<div class="section level3">
<h3 id="id_00-core-ref-r-reference-lambdar-internals">00-core-ref-*.R (reference lambda.r internals)<a class="anchor" aria-label="anchor" href="#id_00-core-ref-r-reference-lambdar-internals"></a></h3>
<ul><li><code>R/00-core-ref-helpers.R</code></li>
<li><code>R/00-core-ref-constructors.R</code></li>
<li><code>R/00-core-ref-measured.R</code></li>
<li><code>R/00-core-ref-monoid-resolution.R</code></li>
<li><code>R/00-core-ref-view.R</code></li>
<li><code>R/00-core-ref-split-digit.R</code></li>
<li><code>R/00-core-ref-split-tree-impl.R</code></li>
<li><code>R/00-core-ref-locate-impl.R</code></li>
<li><code>R/00-core-ref-add-left.R</code></li>
<li><code>R/00-core-ref-add-right.R</code></li>
<li><code>R/00-core-ref-concat.R</code></li>
</ul></div>
<div class="section level3">
<h3 id="id_10-core-fast-r-r-pure-r-fast-helpers">10-core-fast-r-*.R (pure R fast helpers)<a class="anchor" aria-label="anchor" href="#id_10-core-fast-r-r-pure-r-fast-helpers"></a></h3>
<ul><li><code>R/10-core-fast-r-add-left.R</code></li>
<li><code>R/10-core-fast-r-add-right-and-measure.R</code></li>
<li><code>R/10-core-fast-r-concat.R</code></li>
<li>Keep <code>*_fast</code> and <code>*_impl</code> plain-R helpers here.</li>
</ul></div>
<div class="section level3">
<h3 id="id_20-backend-cpp-r-c-gateway">20-backend-cpp-*.R (C++ gateway)<a class="anchor" aria-label="anchor" href="#id_20-backend-cpp-r-c-gateway"></a></h3>
<ul><li>
<code>R/20-backend-cpp.R</code> (from <code>R/cpp_backend.R</code>)</li>
</ul></div>
<div class="section level3">
<h3 id="id_30-api-flexseq-r-exported-flexseq-api--wrappers">30-api-flexseq-*.R (exported flexseq API + wrappers)<a class="anchor" aria-label="anchor" href="#id_30-api-flexseq-r-exported-flexseq-api--wrappers"></a></h3>
<ul><li>
<code>R/30-api-flexseq-core.R</code> (from <code>R/flexseq.R</code>)</li>
<li>
<code>R/30-api-flexseq-measure-monoid.R</code> (from <code>R/MeasureMonoid.R</code>)</li>
<li>
<code>R/30-api-flexseq-predicate.R</code> (from <code>R/Predicate.R</code>)</li>
<li>
<code>R/30-api-flexseq-append.R</code> (from <code>R/append.R</code>)</li>
<li>
<code>R/30-api-flexseq-prepend.R</code> (from <code>R/prepend.R</code>)</li>
<li>
<code>R/30-api-flexseq-fold-left.R</code> (from <code>R/fold_left.R</code>)</li>
<li>
<code>R/30-api-flexseq-fold-right.R</code> (from <code>R/fold_right.R</code>)</li>
<li>
<code>R/30-api-flexseq-split.R</code> (from <code>R/split.R</code>)</li>
<li>
<code>R/30-api-flexseq-split-tree.R</code> (from <code>R/split_tree.R</code>)</li>
<li>
<code>R/30-api-flexseq-locate.R</code> (from <code>R/locate.R</code>)</li>
<li>
<code>R/30-api-flexseq-indexing.R</code> (from <code>R/indexing.R</code>)</li>
<li>
<code>R/30-api-flexseq-dollar.R</code> (from <code>R/dollar.R</code>)</li>
<li>
<code>R/30-api-flexseq-add-monoids.R</code> (from <code>R/add_monoids.R</code>)</li>
<li>
<code>R/30-api-flexseq-print.R</code> (from <code>R/print.FingerTree.R</code>)</li>
<li>
<code>R/30-api-flexseq-validate.R</code> (from <code>R/validate.R</code>)</li>
<li>
<code>R/30-api-flexseq-tree-from.R</code> (from <code>R/tree_from.R</code>, internal)</li>
<li>
<code>R/30-api-flexseq-empty-tree.R</code> (from <code>R/empty_tree.R</code>, internal)</li>
<li>
<code>R/30-api-flexseq-concat-trees.R</code> (from <code>R/concat_trees.R</code>, internal)</li>
</ul></div>
<div class="section level3">
<h3 id="id_40-priority_queue-r">40-priority_queue-*.R<a class="anchor" aria-label="anchor" href="#id_40-priority_queue-r"></a></h3>
<ul><li>
<code>R/40-priority_queue-monoids.R</code> (from <code>R/pq_monoids.R</code>)</li>
<li>
<code>R/40-priority_queue-core.R</code> (from <code>R/priority_queue.R</code>)</li>
<li>
<code>R/40-priority_queue-print.R</code> (from <code>R/print.priority_queue.R</code>)</li>
</ul></div>
<div class="section level3">
<h3 id="id_90-devtools-r-internal-only-helpers">90-devtools-*.R (internal-only helpers)<a class="anchor" aria-label="anchor" href="#id_90-devtools-r-internal-only-helpers"></a></h3>
<ul><li>
<code>R/90-devtools-utils.R</code> (from <code>R/utils.R</code>)</li>
</ul><p>Keep as-is unless necessary: - <code>R/fingertree-package.R</code></p>
</div>
</div>
<div class="section level2">
<h2 id="migration-mapping-rules">Migration Mapping Rules<a class="anchor" aria-label="anchor" href="#migration-mapping-rules"></a></h2>
<ol style="list-style-type: decimal"><li>Use <code>git mv</code> for one-to-one file renames.</li>
<li>For split files (<code>add_left.R</code>, <code>add_right.R</code>, <code>concat.R</code>):</li>
</ol><ul><li>Move lambda.r/reference definitions into <code>00-core-ref-*</code> files.</li>
<li>Move <code>*_fast</code> plain-R helpers into corresponding <code>10-core-fast-r-*</code> files.</li>
</ul><ol start="3" style="list-style-type: decimal"><li>Do not rename functions unless unavoidable.</li>
<li>Keep roxygen blocks attached to the same functions after moves.</li>
<li>Preserve <code>@keywords internal</code> and exported tags unchanged unless explicitly needed.</li>
</ol></div>
<div class="section level2">
<h2 id="phase-by-phase-execution">Phase-by-Phase Execution<a class="anchor" aria-label="anchor" href="#phase-by-phase-execution"></a></h2>
<div class="section level3">
<h3 id="phase-1-skeleton-and-architecture-doc">Phase 1: Skeleton and Architecture Doc<a class="anchor" aria-label="anchor" href="#phase-1-skeleton-and-architecture-doc"></a></h3>
<ol style="list-style-type: decimal"><li>Create <code>docs/architecture.md</code> with:</li>
</ol><ul><li>reference-vs-fast design contract,</li>
<li>backend dispatch policy,</li>
<li>file-family map,</li>
<li>paper citation,</li>
<li>extension guide for future <code>40-&lt;structure&gt;-*.R</code> families.</li>
</ul><ol start="2" style="list-style-type: decimal"><li>Ensure paper citation also appears in package-level docs context:</li>
</ol><ul><li>verify DESCRIPTION/README still clearly reference Hinze/Paterson.</li>
</ul><p>Gate: - <code>R -q -e "roxygen2::roxygenise()"</code> (no broken docs)</p>
</div>
<div class="section level3">
<h3 id="phase-2-mechanical-file-reorganization-no-behavior-changes">Phase 2: Mechanical File Reorganization (No behavior changes)<a class="anchor" aria-label="anchor" href="#phase-2-mechanical-file-reorganization-no-behavior-changes"></a></h3>
<ol style="list-style-type: decimal"><li>Rename straightforward files with <code>git mv</code>.</li>
<li>Split mixed files:</li>
</ol><ul><li>
<code>add_left.R</code> into reference + fast-r files.</li>
<li>
<code>add_right.R</code> into reference + fast-r files.</li>
<li>
<code>concat.R</code> into reference + fast-r files.</li>
</ul><ol start="3" style="list-style-type: decimal"><li>Keep source code bodies unchanged except location and minimal comment edits.</li>
</ol><p>Gate: - <code>R -q -e "testthat::test_local()"</code> - Must remain <code>FAIL 0</code>.</p>
</div>
<div class="section level3">
<h3 id="phase-3-backend-boundary-clarification">Phase 3: Backend Boundary Clarification<a class="anchor" aria-label="anchor" href="#phase-3-backend-boundary-clarification"></a></h3>
<ol style="list-style-type: decimal"><li>Verify every accelerated wrapper in <code>R/20-backend-cpp.R</code> has clear fallback in R path.</li>
<li>Confirm dispatch sites in exported wrappers remain explicit and consistent:</li>
</ol><ul><li>append/prepend/split/split_tree/locate/tree_from/concat_trees/indexing helpers.</li>
</ul><ol start="3" style="list-style-type: decimal"><li>Do not force C++ paths where currently intentionally not used.</li>
</ol><p>Gate: - <code>R -q -e "testthat::test_local()"</code> - <code>R CMD check --no-manual immutables_*.tar.gz</code></p>
</div>
<div class="section level3">
<h3 id="phase-4-test-organization-and-parity-hardening">Phase 4: Test Organization and Parity Hardening<a class="anchor" aria-label="anchor" href="#phase-4-test-organization-and-parity-hardening"></a></h3>
<ol style="list-style-type: decimal"><li>Keep existing tests functional; optional file renames for clarity are allowed if behavior unchanged.</li>
<li>Ensure parity tests still cover accelerated operations:</li>
</ol><ul><li>append/prepend/tree_from/concat/split_tree/split/locate/indexing/name lookup/get-by-index.</li>
</ul><ol start="3" style="list-style-type: decimal"><li>Add a small parity coverage assertion test if missing:</li>
</ol><ul><li>static check that known <code>.ft_cpp_*</code> operations are represented by parity scenarios.</li>
</ul><ol start="4" style="list-style-type: decimal"><li>If any API shape changed, update tests and docs in same commit.</li>
</ol><p>Gate: - <code>R -q -e "testthat::test_local()"</code> with parity green.</p>
</div>
<div class="section level3">
<h3 id="phase-5-documentation-and-site-sync">Phase 5: Documentation and Site Sync<a class="anchor" aria-label="anchor" href="#phase-5-documentation-and-site-sync"></a></h3>
<ol style="list-style-type: decimal"><li>Run <code><a href="https://roxygen2.r-lib.org/reference/roxygenize.html" class="external-link">roxygen2::roxygenise()</a></code>.</li>
<li>Rebuild pkgdown site (<code><a href="https://pkgdown.r-lib.org/reference/build_site.html" class="external-link">pkgdown::build_site()</a></code>) and ensure reference index remains valid.</li>
<li>Confirm docs still present user-facing <code>flexseq</code> methods (not stale pages).</li>
</ol><p>Gate: - <code>R -q -e "roxygen2::roxygenise()"</code> - <code>R -q -e "pkgdown::build_site()"</code></p>
</div>
<div class="section level3">
<h3 id="phase-6-cran-focused-final-validation">Phase 6: CRAN-Focused Final Validation<a class="anchor" aria-label="anchor" href="#phase-6-cran-focused-final-validation"></a></h3>
<ol style="list-style-type: decimal"><li>Full local checks:</li>
</ol><ul><li><code>R -q -e "testthat::test_local()"</code></li>
<li><code>R CMD build .</code></li>
<li><code>R CMD check --no-manual immutables_*.tar.gz</code></li>
</ul><ol start="2" style="list-style-type: decimal"><li>If LaTeX available, run full manual check too:</li>
</ol><ul><li><code>R CMD check immutables_*.tar.gz</code></li>
</ul><ol start="3" style="list-style-type: decimal"><li>Ensure no accidental artifacts are staged:</li>
</ol><ul><li>remove <code>immutables.Rcheck/</code> and tarballs before final commit if policy requires.</li>
</ul></div>
</div>
<div class="section level2">
<h2 id="expected-api-status-after-refactor">Expected API Status After Refactor<a class="anchor" aria-label="anchor" href="#expected-api-status-after-refactor"></a></h2>
<p>Exported set should remain unchanged (from <code>NAMESPACE</code>): - <code>add_monoids</code>, <code>append</code>, <code>as_flexseq</code>, <code>as_priority_queue</code>, <code>extract_max</code>, <code>extract_min</code>, <code>flexseq</code>, <code>fold_left</code>, <code>fold_right</code>, <code>insert</code>, <code>is_empty</code>, <code>locate</code>, <code>measure_monoid</code>, <code>peek_max</code>, <code>peek_min</code>, <code>predicate</code>, <code>prepend</code>, <code>priority_queue</code>, <code>split_tree</code>, <code>validate_name_state</code>, <code>validate_tree</code> - plus S3 methods for <code>flexseq</code>, <code>append.default</code>, <code>append.flexseq</code>, <code>split.flexseq</code>.</p>
<p>If this set changes unintentionally, stop and fix before proceeding.</p>
</div>
<div class="section level2">
<h2 id="cran-safety-checklist">CRAN Safety Checklist<a class="anchor" aria-label="anchor" href="#cran-safety-checklist"></a></h2>
<ol style="list-style-type: decimal"><li>No non-standard files accidentally included in tarball.</li>
<li>Examples remain runnable and concise.</li>
<li>Internal-only helpers remain <code>@keywords internal</code> where appropriate.</li>
<li>No undocumented exports.</li>
<li>
<code>NAMESPACE</code> and <code>man/</code> regenerated from roxygen, not manually edited.</li>
<li>No platform-specific behavior introduced in tests/examples.</li>
</ol></div>
<div class="section level2">
<h2 id="commit-strategy-recommended">Commit Strategy (Recommended)<a class="anchor" aria-label="anchor" href="#commit-strategy-recommended"></a></h2>
<ol style="list-style-type: decimal"><li>Commit A: add architecture doc + no-op prep.</li>
<li>Commit B: mechanical file renames/moves only.</li>
<li>Commit C: split mixed files into 00/10 families.</li>
<li>Commit D: backend boundary clarifications + tests.</li>
<li>Commit E: docs/site/check cleanup.</li>
</ol><p>This makes review and rollback safe.</p>
</div>
<div class="section level2">
<h2 id="completion-definition">Completion Definition<a class="anchor" aria-label="anchor" href="#completion-definition"></a></h2>
<p>All are true: 1. File layout follows 00/10/20/30/40/90 model. 2. Reference lambda.r core is clearly separated from fast-R and C++ layers. 3. Priority queue code is isolated under <code>40-priority_queue-*.R</code>. 4. Tests and parity pass. 5. <code>R CMD check</code> passes (or only user-approved environmental caveats). 6. Paper citation is present and visible in architecture/package documentation.</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Shawn T. O’Neil.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

